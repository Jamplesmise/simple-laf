# Sprint 11: Canvas æ¨¡å¼ - ä»»åŠ¡æ¸…å•

## ä»»åŠ¡æ¦‚è§ˆ

| ä»»åŠ¡ | å­æ¨¡å— | è½¨é“ | ä¼˜å…ˆçº§ | é¢„ä¼° | ä¾èµ– | çŠ¶æ€ |
|------|--------|------|-------|------|------|------|
| 11.1.1 Canvas å¸ƒå±€ç»„ä»¶ | åˆ†å±å¸ƒå±€ | å‰ç«¯ | P0 | 3h | æ—  | âœ… å®Œæˆ |
| 11.1.2 åˆ†å±æ‹–æ‹½è°ƒæ•´ | åˆ†å±å¸ƒå±€ | å‰ç«¯ | P1 | 2h | 11.1.1 | âœ… å®Œæˆ |
| 11.2.1 ä»£ç å¿«ç…§ API | ä»£ç åŒæ­¥ | åç«¯ | P0 | 2h | æ—  | âœ… å®Œæˆ |
| 11.2.2 Diff è®¡ç®—æœåŠ¡ | ä»£ç åŒæ­¥ | åç«¯ | P0 | 2h | æ—  | âœ… å®Œæˆ |
| 11.2.3 ä»£ç åŒæ­¥ç»„ä»¶ | ä»£ç åŒæ­¥ | å‰ç«¯ | P0 | 4h | 11.2.1-2 | âœ… å®Œæˆ |
| 11.3.1 å¿«æ·æ“ä½œç»„ä»¶ | å¿«æ·æ“ä½œ | å‰ç«¯ | P1 | 2h | æ—  | âœ… å®Œæˆ |

---

## 11.1 åˆ†å±å¸ƒå±€

### 11.1.1 Canvas å¸ƒå±€ç»„ä»¶

**æ–‡ä»¶**ï¼š`src/client/components/AI/Canvas/CanvasLayout.tsx`

**å…·ä½“æ­¥éª¤**ï¼š

- [x] å®‰è£… `react-split` ä¾èµ–
- [x] åˆ›å»º Canvas å®¹å™¨ç»„ä»¶
- [x] å®ç°å·¦å³åˆ†å±ï¼ˆå¯¹è¯ + ç¼–è¾‘å™¨ï¼‰
- [x] æ·»åŠ  Canvas æ¨¡å¼å¼€å…³

**UI è®¾è®¡**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [å¯¹è¯åˆ—è¡¨ â–¼]  [æ¨¡å‹é€‰æ‹© â–¼]  [æ·±åº¦æ€è€ƒ â–¡]       [Canvas âŸ·] [âœ•] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  å¯¹è¯æ¶ˆæ¯åŒºåŸŸ                    â”‚  â”‚ function.ts        [â–¼ v3]â”‚â”‚
â”‚                                â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚                            â”‚â”‚
â”‚  â”‚ ç”¨æˆ·: å¸®æˆ‘ä¼˜åŒ–è¿™ä¸ªå‡½æ•°    â”‚  â”‚  â”‚  // ä»£ç ç¼–è¾‘åŒºåŸŸ           â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚                            â”‚â”‚
â”‚                                â”‚  â”‚  export default async...  â”‚â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚                            â”‚â”‚
â”‚  â”‚ AI: æˆ‘æ¥å¸®ä½ ä¼˜åŒ–...       â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ [åº”ç”¨åˆ°ç¼–è¾‘å™¨]            â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ [Review] [Logs] [Comments] â”‚â”‚
â”‚                                â”‚  â”‚ [Format] [Run] [Save]      â”‚â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚ è¾“å…¥æ¶ˆæ¯... (@å¼•ç”¨ /å‘½ä»¤)  [â¤] â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**éªŒæ”¶**ï¼š
- [x] Canvas å¼€å…³å¯åˆ‡æ¢
- [x] åˆ†å±æ˜¾ç¤ºæ­£å¸¸
- [x] ç¼–è¾‘å™¨æ­£ç¡®æ¸²æŸ“

---

### 11.1.2 åˆ†å±æ‹–æ‹½è°ƒæ•´

**æ–‡ä»¶**ï¼š`src/client/components/AI/Canvas/CanvasLayout.tsx`

**å…·ä½“æ­¥éª¤**ï¼š

- [x] åˆ†å‰²çº¿å¯æ‹–æ‹½
- [x] æ‹–æ‹½èŒƒå›´é™åˆ¶ï¼ˆ20%-80%ï¼‰
- [x] æ‹–æ‹½æ—¶å®æ—¶æ›´æ–°å¸ƒå±€
- [x] ä¿å­˜ç”¨æˆ·åå¥½åˆ° localStorage

**éªŒæ”¶**ï¼š
- [x] æ‹–æ‹½æµç•…
- [x] èŒƒå›´é™åˆ¶æœ‰æ•ˆ
- [x] åˆ·æ–°åä¿æŒè®¾ç½®

---

## 11.2 ä»£ç åŒæ­¥

### 11.2.1 ä»£ç å¿«ç…§ API

**æ–‡ä»¶**ï¼š`src/server/routes/ai/canvas.ts`

**API åˆ—è¡¨**ï¼š

```typescript
// è·å–å¿«ç…§åˆ—è¡¨
GET /api/ai/canvas/:conversationId/snapshots
// å“åº”
{
  success: true,
  data: [
    { id, version, description, createdAt }
  ]
}

// åˆ›å»ºå¿«ç…§
POST /api/ai/canvas/:conversationId/snapshot
// è¯·æ±‚
{ functionId, code, description? }
// å“åº”
{ success: true, data: { id, version } }

// åº”ç”¨ä»£ç 
POST /api/ai/canvas/apply
// è¯·æ±‚
{ snapshotId, functionId }
// å“åº”
{ success: true }
```

**éªŒæ”¶**ï¼š
- [x] å¿«ç…§åˆ—è¡¨è¿”å›æ­£ç¡®
- [x] åˆ›å»ºå¿«ç…§æˆåŠŸ
- [x] åº”ç”¨ä»£ç åˆ°å‡½æ•°æˆåŠŸ

---

### 11.2.2 Diff è®¡ç®—æœåŠ¡

**æ–‡ä»¶**ï¼š`src/server/services/ai/canvas/diff.ts`

**å…·ä½“æ­¥éª¤**ï¼š

- [x] å®‰è£… `diff-match-patch` ä¾èµ–
- [x] å®ç° `calculateDiff(before, after)` å‡½æ•°
- [x] è¿”å›è¡Œçº§åˆ«å˜æ›´ä¿¡æ¯

```typescript
interface DiffResult {
  changes: {
    type: 'add' | 'remove' | 'equal',
    content: string,
    lineStart: number,
    lineEnd: number
  }[]
  stats: {
    added: number,
    removed: number,
    modified: number
  }
}
```

**éªŒæ”¶**ï¼š
- [x] Diff è®¡ç®—å‡†ç¡®
- [x] è¡Œå·æ˜ å°„æ­£ç¡®
- [x] æ€§èƒ½æ»¡è¶³å¤§æ–‡ä»¶éœ€æ±‚

---

### 11.2.3 ä»£ç åŒæ­¥ç»„ä»¶

**æ–‡ä»¶**ï¼š`src/client/components/AI/Canvas/CodePane.tsx`

**å…·ä½“æ­¥éª¤**ï¼š

- [x] åˆ›å»º `CodePane` ä¸»ç»„ä»¶
- [x] å¤ç”¨ç°æœ‰ Monaco Editor
- [x] å®ç° AI è¾“å‡ºä»£ç è‡ªåŠ¨å¡«å……
- [x] åˆ›å»º `DiffView` å¯¹æ¯”è§†å›¾
- [x] åˆ›å»º `VersionHistory` ç‰ˆæœ¬åˆ—è¡¨

**éªŒæ”¶**ï¼š
- [x] AI ç”Ÿæˆä»£ç è‡ªåŠ¨åŒæ­¥åˆ°ç¼–è¾‘å™¨
- [x] Diff è§†å›¾æ¸…æ™°æ˜¾ç¤ºå˜æ›´
- [x] å¯åˆ‡æ¢å†å²ç‰ˆæœ¬
- [x] åº”ç”¨æŒ‰é’®æ­£å¸¸å·¥ä½œ

---

## 11.3 å¿«æ·æ“ä½œ

### 11.3.1 å¿«æ·æ“ä½œç»„ä»¶

**æ–‡ä»¶**ï¼š`src/client/components/AI/Canvas/QuickActions.tsx`

**é¢„è®¾æ“ä½œ**ï¼š

```typescript
const quickActions = [
  { key: 'review', label: 'Review', icon: 'ğŸ”', prompt: 'å®¡æŸ¥è¿™æ®µä»£ç ï¼ŒæŒ‡å‡ºé—®é¢˜å’Œæ”¹è¿›å»ºè®®' },
  { key: 'logs', label: 'Add logs', icon: 'ğŸ“', prompt: 'åœ¨å…³é”®ä½ç½®æ·»åŠ è°ƒè¯•æ—¥å¿—' },
  { key: 'comments', label: 'Comments', icon: 'ğŸ’¬', prompt: 'ä¸ºä»£ç æ·»åŠ æ¸…æ™°çš„æ³¨é‡Š' },
  { key: 'fix', label: 'Fix bugs', icon: 'ğŸ›', prompt: 'æ£€æµ‹å¹¶ä¿®å¤ä»£ç ä¸­çš„é—®é¢˜' },
  { key: 'optimize', label: 'Optimize', icon: 'âš¡', prompt: 'ä¼˜åŒ–ä»£ç æ€§èƒ½' },
  { key: 'types', label: 'Add types', icon: 'ğŸ“', prompt: 'æ·»åŠ  TypeScript ç±»å‹å®šä¹‰' },
]
```

**éªŒæ”¶**ï¼š
- [x] 6 ä¸ªå¿«æ·æ“ä½œæŒ‰é’®æ˜¾ç¤º
- [x] ç‚¹å‡»è§¦å‘å¯¹åº”å¯¹è¯
- [x] æ“ä½œç»“æœæ­£ç¡®å±•ç¤º

---

## å¹¶è¡Œå¼€å‘è¯´æ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Sprint 11 å¹¶è¡Œå¼€å‘å›¾                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚  åç«¯å¼€å‘è€…:                                                â”‚
â”‚  â”œâ”€ 11.2.1 ä»£ç å¿«ç…§ API (2h)                               â”‚
â”‚  â””â”€ 11.2.2 Diff è®¡ç®—æœåŠ¡ (2h)                              â”‚
â”‚                                                            â”‚
â”‚  å‰ç«¯å¼€å‘è€… A:                                              â”‚
â”‚  â”œâ”€ 11.1.1 Canvas å¸ƒå±€ç»„ä»¶ (3h)                            â”‚
â”‚  â””â”€ 11.1.2 åˆ†å±æ‹–æ‹½è°ƒæ•´ (2h)                               â”‚
â”‚                                                            â”‚
â”‚  å‰ç«¯å¼€å‘è€… B:                                              â”‚
â”‚  â”œâ”€ 11.2.3 ä»£ç åŒæ­¥ç»„ä»¶ (4h) â†’ ä¾èµ– 11.2.1-2               â”‚
â”‚  â””â”€ 11.3.1 å¿«æ·æ“ä½œç»„ä»¶ (2h)                               â”‚
â”‚                                                            â”‚
â”‚  æ—¶é—´çº¿:                                                    â”‚
â”‚  Day 1: åç«¯å®Œæˆ + å‰ç«¯å¸ƒå±€å®Œæˆ                             â”‚
â”‚  Day 2: ä»£ç åŒæ­¥ + å¿«æ·æ“ä½œ                                 â”‚
â”‚  Day 3: é›†æˆæµ‹è¯•                                           â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æµ‹è¯•æ¸…å•

- [ ] å•å…ƒæµ‹è¯•ï¼šDiff è®¡ç®—å‡†ç¡®æ€§
- [ ] é›†æˆæµ‹è¯•ï¼šå¿«ç…§åˆ›å»ºå’Œåº”ç”¨æµç¨‹
- [ ] E2E æµ‹è¯•ï¼šCanvas æ¨¡å¼å®Œæ•´æµç¨‹
- [ ] æ€§èƒ½æµ‹è¯•ï¼šå¤§æ–‡ä»¶ Diff è®¡ç®—æ€§èƒ½
