# Sprint 16: ä¸Šä¸‹æ–‡ç²¾å‡†æ§åˆ¶ - ä»»åŠ¡æ¸…å•

## ä»»åŠ¡æ¦‚è§ˆ

| ä»»åŠ¡ | è½¨é“ | ä¼˜å…ˆçº§ | é¢„ä¼° | ä¾èµ– | çŠ¶æ€ |
|------|------|-------|------|------|------|
| 16.1.1 ç²¾å‡†æ›´æ–°ç­–ç•¥ | åç«¯ | P0 | 3h | æ—  | âœ… å®Œæˆ |
| 16.1.2 ç²¾å‡†æ›´æ–°ç»„ä»¶ | å‰ç«¯ | P0 | 2h | 16.1.1 | âœ… å®Œæˆ |
| 16.2.1 Plan æ¨¡å¼æœåŠ¡ | åç«¯ | P0 | 4h | æ—  | âœ… å®Œæˆ |
| 16.2.2 Plan æ¨¡å¼ UI | å‰ç«¯ | P0 | 4h | 16.2.1 | âœ… å®Œæˆ |

---

## 16.1 ç²¾å‡†æ›´æ–°æ“ä½œ

### 16.1.1 ç²¾å‡†æ›´æ–°ç­–ç•¥ âœ…

**æ–‡ä»¶**ï¼š`src/server/services/ai/context/preciseUpdate.ts`

**å…·ä½“æ­¥éª¤**ï¼š

- [x] å®ç°ä¿®æ”¹èŒƒå›´æ£€æµ‹ - `determineChangeType()`
- [x] å®ç°éƒ¨åˆ†ä»£ç åŠ è½½ - `getMinimalContext()`, `getSmartContext()`
- [x] å®ç°ä¸Šä¸‹æ–‡å¤ç”¨ - `applyPreciseDiff()`, `validateDiff()`

**API è·¯ç”±** (`src/server/routes/ai/context.ts`):
- [x] `POST /api/ai/functions/:id/smart-context`
- [x] `POST /api/ai/functions/:id/precise-context`
- [x] `POST /api/ai/functions/:id/precise-update`
- [x] `POST /api/ai/analyze-change-type`

**éªŒæ”¶**ï¼š
- [x] minor ç±»å‹åªåŠ è½½ Â±10 è¡Œ
- [x] Token æ¶ˆè€—æ˜¾è‘—å‡å°‘

---

### 16.1.2 ç²¾å‡†æ›´æ–°ç»„ä»¶ âœ…

**æ–‡ä»¶**ï¼š`src/client/components/AI/PreciseUpdate/index.tsx`

- [x] è¯·æ±‚å°è£… - `aiConversationApi` æ–°å¢ç²¾å‡†æ›´æ–° API
- [x] ä¿®æ”¹é¢„è§ˆ - `PreciseUpdate` ç»„ä»¶ + `PreciseUpdateIndicator` æŒ‡ç¤ºå™¨

---

## 16.2 Plan æ¨¡å¼

### 16.2.1 Plan æ¨¡å¼æœåŠ¡ âœ…

**æ–‡ä»¶**ï¼š`src/server/services/ai/plan/index.ts`

**å…·ä½“æ­¥éª¤**ï¼š

- [x] å®ç°è®¡åˆ’ç”Ÿæˆï¼ˆåªè¯»åˆ†æï¼‰- `generatePlan()`
- [x] å®ç°è®¡åˆ’æ‰§è¡Œï¼ˆæŒ‰æ­¥éª¤ï¼‰- `executePlan()` (AsyncGenerator)
- [x] å®ç°çŠ¶æ€ç®¡ç†ï¼ˆæš‚åœ/æ¢å¤/åœæ­¢ï¼‰- `pausePlan()`, `resumePlan()`, `stopPlan()`

**API è·¯ç”±** (`src/server/routes/ai/plan.ts`):
- [x] `POST /api/ai/plan/check` - æ£€æŸ¥è§¦å‘
- [x] `POST /api/ai/plan/generate` - ç”Ÿæˆè®¡åˆ’
- [x] `GET /api/ai/plan/:id` - è·å–è¯¦æƒ…
- [x] `PATCH /api/ai/plan/:id/steps` - æ›´æ–°æ­¥éª¤é€‰æ‹©
- [x] `POST /api/ai/plan/:id/execute` - æ‰§è¡Œï¼ˆSSEï¼‰
- [x] `POST /api/ai/plan/:id/pause` - æš‚åœ
- [x] `POST /api/ai/plan/:id/resume` - æ¢å¤
- [x] `POST /api/ai/plan/:id/stop` - åœæ­¢
- [x] `GET /api/ai/plans` - è®¡åˆ’åˆ—è¡¨
- [x] `DELETE /api/ai/plan/:id` - åˆ é™¤è®¡åˆ’

**éªŒæ”¶**ï¼š
- [x] è®¡åˆ’ç”Ÿæˆæ­£ç¡®
- [x] æ­¥éª¤å¯é€‰æ‹©æ‰§è¡Œ
- [x] æš‚åœ/æ¢å¤/åœæ­¢æ­£å¸¸

---

### 16.2.2 Plan æ¨¡å¼ UI âœ…

**æ–‡ä»¶**ï¼š`src/client/components/AI/PlanMode/index.tsx`

**å®ç°çš„ç»„ä»¶**ï¼š
- [x] `PlanMode` - ä¸»ç»„ä»¶ï¼ˆè®¡åˆ’å±•ç¤ºã€æ­¥éª¤é€‰æ‹©ã€æ‰§è¡Œæ§åˆ¶ï¼‰
- [x] `PlanModeTrigger` - è§¦å‘æç¤ºç»„ä»¶

**UI åŠŸèƒ½**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¯ æ‰§è¡Œè®¡åˆ’: é‡æ„ç”¨æˆ·è®¤è¯æ¨¡å—                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“Š åˆ†æç»“æœ                                         â”‚
â”‚ - å½“å‰ authMiddleware.ts åŒ…å« 450 è¡Œä»£ç             â”‚
â”‚ - èŒè´£æ··æ‚ï¼Œå»ºè®®æ‹†åˆ†ä¸º 4 ä¸ªæ¨¡å—                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“‹ æ‰§è¡Œæ­¥éª¤                                         â”‚
â”‚ â˜‘ Step 1: åˆ›å»º services/auth/ ç›®å½•                 â”‚
â”‚ â˜‘ Step 2: æå– TokenService                        â”‚
â”‚ â˜ Step 3: æå– SessionService                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âš ï¸ å½±å“: æ–°å¢ 4 æ–‡ä»¶ | ä¿®æ”¹ 8 æ–‡ä»¶ | é£é™©: ä¸­ç­‰       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           [æ‰§è¡Œé€‰ä¸­] [ä¿®æ”¹è®¡åˆ’] [å–æ¶ˆ]               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**éªŒæ”¶**ï¼š
- [x] è®¡åˆ’å±•ç¤ºæ¸…æ™°
- [x] æ­¥éª¤å¯å‹¾é€‰
- [x] æ‰§è¡Œè¿›åº¦å®æ—¶æ˜¾ç¤º

---

## è§¦å‘æ¡ä»¶ âœ…

è‡ªåŠ¨è§¦å‘ Plan æ¨¡å¼çš„æ¡ä»¶ï¼ˆå·²å®ç°ï¼‰ï¼š

```typescript
const PLAN_TRIGGER_KEYWORDS = [
  'é‡æ„', 'é‡å†™', 'é‡æ–°è®¾è®¡',
  'æ‹†åˆ†', 'åˆå¹¶', 'æå–',
  'è¿ç§»', 'ç§»åŠ¨',
  'æ‰¹é‡', 'å…¨éƒ¨',
  'æ¶æ„', 'è®¾è®¡æ¨¡å¼',
  'å®Œå…¨é‡å†™', 'ä»å¤´å¼€å§‹',
  'å¤šä¸ªå‡½æ•°', 'å¤šä¸ªæ–‡ä»¶',
]

const IMPACT_THRESHOLDS = {
  filesAffected: 3,
  linesChanged: 100
}
```

---

## æ–°å¢æ–‡ä»¶æ¸…å•

```
åç«¯:
â”œâ”€â”€ src/server/services/ai/context/preciseUpdate.ts   # ç²¾å‡†æ›´æ–°æœåŠ¡
â”œâ”€â”€ src/server/services/ai/plan/index.ts              # Plan æ¨¡å¼æœåŠ¡
â””â”€â”€ src/server/routes/ai/plan.ts                      # Plan æ¨¡å¼è·¯ç”±

å‰ç«¯:
â”œâ”€â”€ src/client/components/AI/PreciseUpdate/index.tsx  # ç²¾å‡†æ›´æ–°ç»„ä»¶
â””â”€â”€ src/client/components/AI/PlanMode/index.tsx       # Plan æ¨¡å¼ç»„ä»¶

ä¿®æ”¹:
â”œâ”€â”€ src/server/services/ai/context/index.ts           # å¯¼å‡ºç²¾å‡†æ›´æ–°
â”œâ”€â”€ src/server/routes/ai/context.ts                   # æ·»åŠ ç²¾å‡†æ›´æ–° API
â”œâ”€â”€ src/server/routes/ai/index.ts                     # æ³¨å†Œ Plan è·¯ç”±
â””â”€â”€ src/client/api/aiConversation.ts                  # æ·»åŠ å‰ç«¯ API
```

---

## ç¼–è¯‘éªŒè¯ âœ…

- [x] åç«¯ç¼–è¯‘é€šè¿‡ (`pnpm build:server`)
- [x] å‰ç«¯ç¼–è¯‘é€šè¿‡ (`pnpm build:client`)
