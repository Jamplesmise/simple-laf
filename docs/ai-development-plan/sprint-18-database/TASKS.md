# Sprint 18: 数据库增强 - 任务清单

## 任务概览

| 任务 | 轨道 | 优先级 | 预估 | 依赖 | 状态 |
|------|------|-------|------|------|------|
| 18.1.1 集合分析工具 | 后端 | P0 | 2h | 无 | ✅ 完成 |
| 18.1.2 查询执行工具 | 后端 | P0 | 2h | 无 | ✅ 完成 |
| 18.2.1 索引建议工具 | 后端 | P1 | 3h | 18.1.1 | ✅ 完成 |

---

## 18.1 集合分析

### 18.1.1 集合分析工具 ✅

**文件**：`src/server/services/ai/tools/database.ts`

**实现功能**：
- 文档统计（数量、平均大小、总大小）
- Schema 推断（字段类型、是否可空、出现频率、样本值）
- 索引信息列表（名称、键、唯一性）

**验收**：
- [x] 文档统计正确
- [x] Schema 推断准确
- [x] 索引列表正确

---

### 18.1.2 查询执行工具 ✅

**文件**：`src/server/services/ai/tools/database.ts`

**实现功能**：
- 只读查询执行（禁止 `$set`, `$unset` 等修改操作符）
- 结果数量限制（最大 100 条）
- 敏感字段自动脱敏（password, token, secret, apiKey 等）
- 支持投影、排序、分页

**验收**：
- [x] 查询执行正确
- [x] 结果数量限制
- [x] 敏感字段脱敏

---

## 18.2 查询优化建议

### 18.2.1 索引建议工具 ✅

**文件**：`src/server/services/ai/tools/database.ts`

**实现功能**：
- 分析现有索引
- 检测常用查询字段（userId, createdAt, status 等）
- 检测外键字段（ObjectId 类型）
- 复合索引建议（如 userId + createdAt）
- 警告过多/过少索引

**验收**：
- [x] 分析现有索引
- [x] 建议合理
- [x] 影响评估准确

---

## 完成的文件变更

```
src/server/services/ai/
├── tools/
│   ├── database.ts     # 新增 - 工具实现
│   └── index.ts        # 更新 - 导出
├── tools.ts            # 更新 - 工具定义
├── types.ts            # 更新 - 操作类型
└── executor/
    ├── operations/
    │   ├── database.ts # 新增 - 执行器
    │   └── index.ts    # 更新 - 导出
    └── executor.ts     # 更新 - 执行逻辑
```

## 并行开发说明

所有任务为纯后端，已完全开发完成。
