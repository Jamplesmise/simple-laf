# Phase 5: 集成部署

## 阶段目标

构建单 Docker 镜像，支持在 Sealos 等平台一键部署。

## 功能范围

### 包含

- 单镜像 Docker 构建
- 环境变量配置
- 端到端测试

### 不包含

- Kubernetes 部署
- CI/CD 流水线
- 监控告警
- 多副本负载均衡

## 部署架构 (单镜像)

```
┌─────────────────────────────────────────────────────────────┐
│                        用户浏览器                            │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│              simple-ide (单镜像, 端口 3000)                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    Express Server                    │   │
│  │                                                      │   │
│  │  /              → 静态文件 (React 构建产物)           │   │
│  │  /api/auth/*    → 用户认证 (JWT)                     │   │
│  │  /api/functions/*→ 函数 CRUD + 编译                  │   │
│  │  /invoke/:name  → 函数调用 (代理到 Dify Sandbox)      │   │
│  │  /_/lsp         → LSP WebSocket                      │   │
│  └─────────────────────────┬────────────────────────────┘   │
└─────────────────────────────┼───────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              ▼               ▼               ▼
       ┌──────────┐   ┌─────────────┐   ┌──────────┐
       │ MongoDB  │   │Dify Sandbox │   │   LSP    │
       │ (托管)   │   │  (外部)     │   │ (内置)   │
       └──────────┘   └─────────────┘   └──────────┘
```

## 目录结构

```
simple-ide/
├── src/                    # 后端源码
│   ├── index.ts           # Express 入口 (托管静态文件)
│   └── ...
├── web/                    # 前端源码
│   ├── src/
│   └── dist/              # 构建产物 → 被后端托管
├── Dockerfile             # 单镜像构建
├── .dockerignore
├── .env.example
└── package.json
```

## 环境变量

```bash
# 必需
MONGO_URL=mongodb://...     # MongoDB 连接字符串
JWT_SECRET=your-secret      # JWT 签名密钥
SANDBOX_URL=https://...     # Dify Sandbox URL
SANDBOX_API_KEY=...         # Dify Sandbox API Key

# 可选
PORT=3000                   # 服务端口 (默认 3000)
```

## Sealos 部署流程

```
1. 构建镜像 → 推送到镜像仓库
2. 在 Sealos 创建应用
3. 配置环境变量
4. 使用 Sealos 托管的 MongoDB
5. 暴露端口 3000
```

## 验收标准

- [ ] docker build 构建成功
- [ ] docker run 启动成功
- [ ] 访问 http://localhost:3000 显示 IDE
- [ ] 完整功能流程测试通过
- [ ] 环境变量正确生效

## 依赖

- Phase 1-4 全部完成

## 后续扩展

- 添加 HTTPS 支持 (Sealos 自动提供)
- 添加 CI/CD
- 考虑多副本部署
