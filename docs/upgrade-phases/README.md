# Simple IDE 升级计划

> 目标：从基础版升级到接近 laf 原版体验

## 背景

基础版 Simple IDE 已完成，现需升级以支持更多 laf 核心功能。

## 升级阶段

| Sprint | 名称 | 目标 | 工作量 | 状态 |
|--------|------|------|--------|------|
| Sprint 1 | 基础架构 | 本地执行引擎 + 发布功能 + 布局改造 | 1.5 天 | ✅ 完成 |
| Sprint 2 | 依赖与调试 | NPM 依赖管理 + 调试面板 | 1.5 天 | ✅ 完成 |
| Sprint 3 | 版本与环境 | 历史版本 + 环境变量 | 1.5 天 | ✅ 完成 |
| Sprint 4 | 结构与同步 | 文件夹管理 + Git 同步 | 1.5 天 | ✅ 完成 |
| Sprint 5 | AI 辅助 | AI 代码生成 + 解耦 + 诊断 + 日志分析 | 2 天 | ✅ 完成 |
| Sprint 6 | 数据管理 | MongoDB 集合管理 + S3 对象存储 | 5 天 | ✅ 完成 |
| Sprint 7 | 运维增强 | API Token + 自定义域名 + 审计日志 | 3 天 | ✅ 完成 |
| Sprint 8 | 安全加固 | 速率限制 + 函数重命名 + 错误处理 | 2 天 | ✅ 完成 |
| Sprint 9 | 站点托管 | 静态站点托管 + AI 建站助手 | 3 天 | ✅ 完成 |

**总计**：9 个 Sprint 全部完成，当前版本 v2.0.0

---

## 目录结构

```
docs/upgrade-phases/
├── README.md                     # 本文件
├── sprint-1-base/                # Sprint 1：基础架构
│   ├── CONTEXT.md
│   └── TASKS.md
├── sprint-2-deps/                # Sprint 2：依赖与调试
│   ├── CONTEXT.md
│   └── TASKS.md
├── sprint-3-version/             # Sprint 3：版本与环境
│   ├── CONTEXT.md
│   └── TASKS.md
├── sprint-4-structure/           # Sprint 4：结构与同步
│   ├── CONTEXT.md
│   └── TASKS.md
├── sprint-5-ai/                  # Sprint 5：AI 辅助
│   ├── CONTEXT.md
│   └── TASKS.md
├── sprint-6-data/                # Sprint 6：数据管理
│   ├── CONTEXT.md
│   └── TASKS.md
├── (sprint-7/8 集成在代码中)      # Sprint 7-8：运维增强+安全加固
└── sprint-9-site/                # Sprint 9：站点托管
    ├── CONTEXT.md
    └── TASKS.md
```

---

## 依赖关系

```
                    ┌─→ Sprint 3 (版本+环境) ──┐
Sprint 1 (基础) ───┤                          ├─→ Sprint 5 (AI 辅助) ──┐
                    └─→ Sprint 2 (依赖) ───→ Sprint 4 (结构+同步) ──┘   │
                                                                        ├─→ Sprint 6 (数据管理)
                                                                        │
Sprint 6 可与 Sprint 5 并行开发 ─────────────────────────────────────────┘

前端布局可与所有后端任务并行开发
Sprint 5 依赖前 4 个 Sprint 完成
Sprint 6 只依赖 Sprint 1 (基础架构)，可提前开发
```

---

## 关键里程碑

| 里程碑 | 验收标准 | 依赖 Sprint |
|--------|---------|-------------|
| M1 | 函数通过 Node.js VM 本地执行 | Sprint 1 |
| M2 | 发布函数获得公开访问 URL | Sprint 1 |
| M3 | 前端三栏布局显示正常 | Sprint 1 |
| M4 | 动态添加 NPM 依赖并使用 | Sprint 2 |
| M5 | 调试面板可设置请求参数 | Sprint 2 |
| M6 | 发布时显示 Diff 对比 | Sprint 3 |
| M7 | 环境变量注入成功 | Sprint 3 |
| M8 | 文件夹拖拽调整层级 | Sprint 4 |
| M9 | Git 拉取/推送函数成功 | Sprint 4 |
| M10 | AI 配置多供应商切换 | Sprint 5 |
| M11 | 自然语言生成云函数代码 | Sprint 5 |
| M12 | 函数解耦拆分建议 | Sprint 5 |
| M13 | MongoDB 集合列表和文档 CRUD | Sprint 6 |
| M14 | 索引管理功能 | Sprint 6 |
| M15 | S3 对象存储连接和配置 | Sprint 6 |
| M16 | 文件浏览和上传下载 | Sprint 6 |
| M17 | 静态站点文件托管和预览 | Sprint 9 |
| M18 | AI 创建/编辑站点文件 | Sprint 9 |

---

## 架构变更

### 升级前

```
┌─────────────────────────────────────────┐
│           simple-ide (单镜像)            │
│  /api/auth/*      → JWT 认证            │
│  /api/functions/* → 函数 CRUD           │
│  /invoke/:name    → 调用 (需认证)        │
│  /_/lsp           → LSP WebSocket       │
└─────────────────────────────────────────┘
        ↓ 调用
   Dify Sandbox (外部)
```

### 升级后

```
┌─────────────────────────────────────────────────────────────┐
│                    simple-ide (单镜像)                       │
├─────────────────────────────────────────────────────────────┤
│  API 端点                                                   │
│  ├─ /api/auth/*           用户认证                          │
│  ├─ /api/functions/*      函数 CRUD + 发布                  │
│  ├─ /api/functions/:id/versions  历史版本                   │
│  ├─ /api/folders/*        文件夹管理                        │
│  ├─ /api/dependencies/*   NPM 依赖管理                      │
│  ├─ /api/env/*            环境变量管理                      │
│  ├─ /api/git/*            Git 同步                         │
│  ├─ /invoke/:name         调用 (需认证)                     │
│  ├─ /*                    公开调用 (无需认证)                │
│  └─ /_/lsp                LSP WebSocket                    │
├─────────────────────────────────────────────────────────────┤
│  内部组件                                                   │
│  ├─ Node.js VM 执行引擎                                     │
│  ├─ typescript-language-server                             │
│  └─ NPM 包管理                                              │
└─────────────────────────────────────────────────────────────┘
        │           │           │
        ▼           ▼           ▼
   ┌────────┐  ┌────────┐  ┌────────────────┐
   │MongoDB │  │  S3    │  │ 持久卷          │
   │(数据)  │  │(文件)  │  │(node_modules)  │
   └────────┘  └────────┘  └────────────────┘
```

---

## 数据库集合

| 集合 | 用途 | 新增 |
|------|------|------|
| `users` | 用户信息 | - |
| `functions` | 函数代码 (含 path, folderId) | 扩展 |
| `folders` | 文件夹结构 | ✅ 新增 |
| `function_versions` | 历史版本 | ✅ 新增 |
| `dependencies` | NPM 依赖 | ✅ 新增 |
| `env_variables` | 环境变量 | ✅ 新增 |
| `git_config` | Git 配置 | ✅ 新增 |
| `s3_config` | S3 对象存储配置 | ✅ 新增 (Sprint 6) |

---

## 并行开发安排

```
         Day 1        Day 2        Day 3        Day 4        Day 5        Day 6
        ┌─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬─────────────┐
后端    │ 本地执行    │ NPM 依赖    │ NPM 完成    │ 历史版本    │ 文件夹      │ Git 同步    │
        │ 发布功能    │ 部署优化    │             │ 环境变量    │ 路径联动    │ 格式转换    │
        ├─────────────┼─────────────┼─────────────┼─────────────┼─────────────┼─────────────┤
前端    │ 三栏布局    │ 调试面板    │ Console     │ 发布弹窗    │ 文件树      │ Git 面板    │
        │ 左侧栏      │ 多标签      │ 依赖面板    │ 环境变量    │ 右键菜单    │ 同步状态    │
        └─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴─────────────┘
           Sprint 1        Sprint 2              Sprint 3           Sprint 4

         Day 7        Day 8        Day 9        Day 10       Day 11       Day 12       Day 13
        ┌─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬─────────────┬─────────────┐
后端    │ AI 供应商   │ AI 生成     │ MongoDB     │ MongoDB     │ S3 配置     │ S3 对象     │ 集成测试    │
        │ AI 配置     │ AI 诊断     │ 集合 API    │ 文档索引    │ S3 存储桶   │ 上传下载    │             │
        ├─────────────┼─────────────┼─────────────┼─────────────┼─────────────┼─────────────┼─────────────┤
前端    │ AI 面板     │ AI 对话     │ 集合列表    │ 文档编辑器  │ S3 配置     │ 文件列表    │ 文件预览    │
        │ AI 设置     │ 日志分析    │ 查询构建    │ 索引管理    │ 存储桶列表  │ 上传组件    │ 拖拽上传    │
        └─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴─────────────┴─────────────┘
           Sprint 5                    Sprint 6 (MongoDB)        Sprint 6 (S3)
```

---

## MVP 最小可用版本

完成 **Sprint 1 + Sprint 2** (3 天) 即可获得：

- ✅ 本地执行引擎 (无外部依赖)
- ✅ 函数发布和公开访问
- ✅ NPM 依赖动态安装
- ✅ laf 风格三栏布局
- ✅ 调试面板和 Console

## 完整版功能 (v2.0.0)

完成 **Sprint 1-9** 获得完整功能：

- ✅ 云函数开发全流程
- ✅ AI 辅助编程 (多模型支持)
- ✅ MongoDB 数据管理
- ✅ S3 对象存储管理
- ✅ API Token 认证
- ✅ 自定义域名
- ✅ 函数审计日志
- ✅ 速率限制
- ✅ 静态站点托管
- ✅ AI 建站助手

---

*文档版本：v2.0.0*
*更新日期：2024-12*
